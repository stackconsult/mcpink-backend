---
- name: Add or reconcile a run node
  hosts: "{{ target | default(ansible_limit | default('run')) }}"
  become: true
  roles:
    - role: common
    - role: vswitch
      when: is_dedicated | default(false) | bool
    - role: k3s_agent
    - role: gvisor
    - role: registry_client
    - role: firewall

  post_tasks:
    - name: Wait for node to report Ready
      command: >-
        k3s kubectl get node {{ inventory_hostname }}
        -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_status
      changed_when: false
      retries: 12
      delay: 10
      until: node_status.stdout == "True"
      delegate_to: "{{ groups['ctrl'][0] }}"

    - name: Add run node to Hetzner LB
      command: >-
        hcloud load-balancer add-target {{ hetzner_lb_name }}
        --ip {{ hostvars[inventory_hostname].private_ip }}
      delegate_to: localhost
      become: false
      environment:
        HCLOUD_TOKEN: "{{ hcloud_token }}"

    - name: Cloudflare origin pool reminder
      debug:
        msg: >-
          {{ inventory_hostname }} is Ready.
          Update the Cloudflare Load Balancer origin pool to include {{ ansible_host }} (DNS wildcard A record is not required).
          The node has been added to the Hetzner LB ({{ hetzner_lb_name }}) automatically.
