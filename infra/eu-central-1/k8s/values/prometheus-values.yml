grafana:
  enabled: false

alertmanager:
  alertmanagerSpec:
    nodeSelector:
      pool: ops
    tolerations:
      - key: pool
        operator: Equal
        value: ops
        effect: NoSchedule
    secrets:
      - alertmanager-slack
  config:
    global:
      resolve_timeout: 5m
      slack_api_url_file: /etc/alertmanager/secrets/alertmanager-slack/slack-webhook-url
    route:
      receiver: slack
      group_by: [alertname, namespace]
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        # Silence noisy informational alerts — only page on warning+
        - receiver: "null"
          matchers:
            - severity = info
        # Silence Watchdog heartbeat
        - receiver: "null"
          matchers:
            - alertname = Watchdog
        - receiver: "null"
          matchers:
            - alertname = InfoInhibitor
    receivers:
      - name: "null"
      - name: slack
        slack_configs:
          - channel: "#alerts"
            send_resolved: true
            title: |-
              {{ if eq .Status "firing" }}:fire: [FIRING] {{ .CommonLabels.alertname }}{{ else }}:white_check_mark: [RESOLVED] {{ .CommonLabels.alertname }}{{ end }}
            text: |-
              {{ range .Alerts -}}
              *{{ .Labels.alertname }}*{{ if .Labels.namespace }} ({{ .Labels.namespace }}){{ end }}
              {{ .Annotations.description | default .Annotations.summary | default .Annotations.message | default "" }}
              {{ end }}

# k3s bundles these components — no separate endpoints to scrape
kubeControllerManager:
  enabled: false
kubeProxy:
  enabled: false
kubeScheduler:
  enabled: false
kubeEtcd:
  enabled: false

prometheus:
  prometheusSpec:
    nodeSelector:
      pool: ops
    tolerations:
      - key: pool
        operator: Equal
        value: ops
        effect: NoSchedule
    retention: 30d

# Scrape kubelet /metrics/resource for CRI-based CPU/memory stats.
# cAdvisor metrics are broken for gVisor pods (runsc doesn't populate
# host cgroups), but the CRI stats provider works because
# containerd-shim-runsc-v1 reports stats through the CRI API.
# PodAndContainerStatsFromCRI is Beta/default-on since k8s 1.28.
kubelet:
  serviceMonitor:
    resource: true
    resourcePath: /metrics/resource
    resourceRelabelings:
      - action: replace
        targetLabel: job
        replacement: kubelet-resource

nodeExporter:
  tolerations:
    - key: pool
      operator: Exists
