name: Deploy

on:
  push:
    branches: [main]
    paths:
      - "go-backend/**"

env:
  WORKER_IMAGE: ghcr.io/gluonfield/deployer-worker
  SERVER_IMAGE: ghcr.io/gluonfield/deployer-server

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go-backend/go.mod
          cache: true

      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> "$GITHUB_ENV"

      - name: Build binaries
        working-directory: go-backend
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /tmp/deployer-worker ./cmd/deployer-worker
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /tmp/deployer-server ./cmd/deployer-server

      - name: Prepare image contexts
        run: |
          mkdir -p .tmp-deployer-worker-image .tmp-deployer-server-image

          cat > .tmp-deployer-worker-image/Dockerfile <<'EOF'
          FROM debian:bookworm-slim
          RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates tzdata git && rm -rf /var/lib/apt/lists/*
          WORKDIR /app
          COPY deployer-worker .
          COPY application.yaml .
          CMD ["./deployer-worker"]
          EOF

          cat > .tmp-deployer-server-image/Dockerfile <<'EOF'
          FROM debian:bookworm-slim
          RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates tzdata git && rm -rf /var/lib/apt/lists/*
          WORKDIR /app
          COPY deployer-server .
          COPY application.yaml .
          EXPOSE 8081
          CMD ["./deployer-server"]
          EOF

      - name: Build & push deployer-worker
        run: |
          cp /tmp/deployer-worker .tmp-deployer-worker-image/deployer-worker
          cp go-backend/application.yaml .tmp-deployer-worker-image/application.yaml
          docker build --platform linux/amd64 \
            -t ${{ env.WORKER_IMAGE }}:${{ env.SHORT_SHA }} \
            .tmp-deployer-worker-image/
          docker push ${{ env.WORKER_IMAGE }}:${{ env.SHORT_SHA }}

      - name: Build & push deployer-server
        run: |
          cp /tmp/deployer-server .tmp-deployer-server-image/deployer-server
          cp go-backend/application.yaml .tmp-deployer-server-image/application.yaml
          docker build --platform linux/amd64 \
            -t ${{ env.SERVER_IMAGE }}:${{ env.SHORT_SHA }} \
            .tmp-deployer-server-image/
          docker push ${{ env.SERVER_IMAGE }}:${{ env.SHORT_SHA }}

      - name: Deploy to k3s
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.K3S_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            kubectl set image deployment/deployer-worker \
              worker=${{ env.WORKER_IMAGE }}:${{ env.SHORT_SHA }} \
              -n dp-system
            kubectl set image deployment/deployer-server \
              deployer-server=${{ env.SERVER_IMAGE }}:${{ env.SHORT_SHA }} \
              -n dp-system
            kubectl rollout status deployment/deployer-worker -n dp-system --timeout=120s
            kubectl rollout status deployment/deployer-server -n dp-system --timeout=120s
