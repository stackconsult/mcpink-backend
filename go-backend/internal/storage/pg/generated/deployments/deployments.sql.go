// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: deployments.sql

package deployments

import (
	"context"
)

const cancelInFlightDeployments = `-- name: CancelInFlightDeployments :many
UPDATE deployments
SET status = 'cancelled', finished_at = NOW(), updated_at = NOW()
WHERE service_id = $1 AND status IN ('queued', 'building', 'deploying') AND id != $2
RETURNING workflow_id
`

type CancelInFlightDeploymentsParams struct {
	ServiceID string `json:"service_id"`
	ID        string `json:"id"`
}

func (q *Queries) CancelInFlightDeployments(ctx context.Context, arg CancelInFlightDeploymentsParams) ([]string, error) {
	rows, err := q.db.Query(ctx, cancelInFlightDeployments, arg.ServiceID, arg.ID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []string{}
	for rows.Next() {
		var workflow_id string
		if err := rows.Scan(&workflow_id); err != nil {
			return nil, err
		}
		items = append(items, workflow_id)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const countDeploymentsByServiceID = `-- name: CountDeploymentsByServiceID :one
SELECT COUNT(*) FROM deployments WHERE service_id = $1
`

func (q *Queries) CountDeploymentsByServiceID(ctx context.Context, serviceID string) (int64, error) {
	row := q.db.QueryRow(ctx, countDeploymentsByServiceID, serviceID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createDeployment = `-- name: CreateDeployment :one
INSERT INTO deployments (
    id, service_id, workflow_id, build_pack, build_config, env_vars_snapshot,
    memory, vcpus, port, trigger, trigger_ref, commit_hash
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12
)
RETURNING id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at
`

type CreateDeploymentParams struct {
	ID              string  `json:"id"`
	ServiceID       string  `json:"service_id"`
	WorkflowID      string  `json:"workflow_id"`
	BuildPack       string  `json:"build_pack"`
	BuildConfig     []byte  `json:"build_config"`
	EnvVarsSnapshot []byte  `json:"env_vars_snapshot"`
	Memory          string  `json:"memory"`
	Vcpus           string  `json:"vcpus"`
	Port            string  `json:"port"`
	Trigger         string  `json:"trigger"`
	TriggerRef      *string `json:"trigger_ref"`
	CommitHash      *string `json:"commit_hash"`
}

func (q *Queries) CreateDeployment(ctx context.Context, arg CreateDeploymentParams) (Deployment, error) {
	row := q.db.QueryRow(ctx, createDeployment,
		arg.ID,
		arg.ServiceID,
		arg.WorkflowID,
		arg.BuildPack,
		arg.BuildConfig,
		arg.EnvVarsSnapshot,
		arg.Memory,
		arg.Vcpus,
		arg.Port,
		arg.Trigger,
		arg.TriggerRef,
		arg.CommitHash,
	)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ServiceID,
		&i.WorkflowID,
		&i.WorkflowRunID,
		&i.CommitHash,
		&i.ImageRef,
		&i.BuildPack,
		&i.BuildConfig,
		&i.EnvVarsSnapshot,
		&i.Memory,
		&i.Vcpus,
		&i.Port,
		&i.Status,
		&i.ErrorMessage,
		&i.BuildProgress,
		&i.Trigger,
		&i.TriggerRef,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getActiveDeploymentByServiceID = `-- name: GetActiveDeploymentByServiceID :one
SELECT id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at FROM deployments
WHERE service_id = $1 AND status = 'active'
`

func (q *Queries) GetActiveDeploymentByServiceID(ctx context.Context, serviceID string) (Deployment, error) {
	row := q.db.QueryRow(ctx, getActiveDeploymentByServiceID, serviceID)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ServiceID,
		&i.WorkflowID,
		&i.WorkflowRunID,
		&i.CommitHash,
		&i.ImageRef,
		&i.BuildPack,
		&i.BuildConfig,
		&i.EnvVarsSnapshot,
		&i.Memory,
		&i.Vcpus,
		&i.Port,
		&i.Status,
		&i.ErrorMessage,
		&i.BuildProgress,
		&i.Trigger,
		&i.TriggerRef,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getDeploymentByID = `-- name: GetDeploymentByID :one
SELECT id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at FROM deployments WHERE id = $1
`

func (q *Queries) GetDeploymentByID(ctx context.Context, id string) (Deployment, error) {
	row := q.db.QueryRow(ctx, getDeploymentByID, id)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ServiceID,
		&i.WorkflowID,
		&i.WorkflowRunID,
		&i.CommitHash,
		&i.ImageRef,
		&i.BuildPack,
		&i.BuildConfig,
		&i.EnvVarsSnapshot,
		&i.Memory,
		&i.Vcpus,
		&i.Port,
		&i.Status,
		&i.ErrorMessage,
		&i.BuildProgress,
		&i.Trigger,
		&i.TriggerRef,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getDeploymentByWorkflowID = `-- name: GetDeploymentByWorkflowID :one
SELECT id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at FROM deployments WHERE workflow_id = $1
`

func (q *Queries) GetDeploymentByWorkflowID(ctx context.Context, workflowID string) (Deployment, error) {
	row := q.db.QueryRow(ctx, getDeploymentByWorkflowID, workflowID)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ServiceID,
		&i.WorkflowID,
		&i.WorkflowRunID,
		&i.CommitHash,
		&i.ImageRef,
		&i.BuildPack,
		&i.BuildConfig,
		&i.EnvVarsSnapshot,
		&i.Memory,
		&i.Vcpus,
		&i.Port,
		&i.Status,
		&i.ErrorMessage,
		&i.BuildProgress,
		&i.Trigger,
		&i.TriggerRef,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getLatestDeploymentByServiceID = `-- name: GetLatestDeploymentByServiceID :one
SELECT id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at FROM deployments
WHERE service_id = $1
ORDER BY created_at DESC
LIMIT 1
`

func (q *Queries) GetLatestDeploymentByServiceID(ctx context.Context, serviceID string) (Deployment, error) {
	row := q.db.QueryRow(ctx, getLatestDeploymentByServiceID, serviceID)
	var i Deployment
	err := row.Scan(
		&i.ID,
		&i.ServiceID,
		&i.WorkflowID,
		&i.WorkflowRunID,
		&i.CommitHash,
		&i.ImageRef,
		&i.BuildPack,
		&i.BuildConfig,
		&i.EnvVarsSnapshot,
		&i.Memory,
		&i.Vcpus,
		&i.Port,
		&i.Status,
		&i.ErrorMessage,
		&i.BuildProgress,
		&i.Trigger,
		&i.TriggerRef,
		&i.StartedAt,
		&i.FinishedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getLatestDeploymentsByServiceIDs = `-- name: GetLatestDeploymentsByServiceIDs :many
SELECT DISTINCT ON (service_id) id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at FROM deployments
WHERE service_id = ANY($1::text[])
ORDER BY service_id, created_at DESC
`

func (q *Queries) GetLatestDeploymentsByServiceIDs(ctx context.Context, dollar_1 []string) ([]Deployment, error) {
	rows, err := q.db.Query(ctx, getLatestDeploymentsByServiceIDs, dollar_1)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Deployment{}
	for rows.Next() {
		var i Deployment
		if err := rows.Scan(
			&i.ID,
			&i.ServiceID,
			&i.WorkflowID,
			&i.WorkflowRunID,
			&i.CommitHash,
			&i.ImageRef,
			&i.BuildPack,
			&i.BuildConfig,
			&i.EnvVarsSnapshot,
			&i.Memory,
			&i.Vcpus,
			&i.Port,
			&i.Status,
			&i.ErrorMessage,
			&i.BuildProgress,
			&i.Trigger,
			&i.TriggerRef,
			&i.StartedAt,
			&i.FinishedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listDeploymentsByServiceID = `-- name: ListDeploymentsByServiceID :many
SELECT id, service_id, workflow_id, workflow_run_id, commit_hash, image_ref, build_pack, build_config, env_vars_snapshot, memory, vcpus, port, status, error_message, build_progress, trigger, trigger_ref, started_at, finished_at, created_at, updated_at FROM deployments
WHERE service_id = $1
ORDER BY created_at DESC
LIMIT $2 OFFSET $3
`

type ListDeploymentsByServiceIDParams struct {
	ServiceID string `json:"service_id"`
	Limit     int32  `json:"limit"`
	Offset    int32  `json:"offset"`
}

func (q *Queries) ListDeploymentsByServiceID(ctx context.Context, arg ListDeploymentsByServiceIDParams) ([]Deployment, error) {
	rows, err := q.db.Query(ctx, listDeploymentsByServiceID, arg.ServiceID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Deployment{}
	for rows.Next() {
		var i Deployment
		if err := rows.Scan(
			&i.ID,
			&i.ServiceID,
			&i.WorkflowID,
			&i.WorkflowRunID,
			&i.CommitHash,
			&i.ImageRef,
			&i.BuildPack,
			&i.BuildConfig,
			&i.EnvVarsSnapshot,
			&i.Memory,
			&i.Vcpus,
			&i.Port,
			&i.Status,
			&i.ErrorMessage,
			&i.BuildProgress,
			&i.Trigger,
			&i.TriggerRef,
			&i.StartedAt,
			&i.FinishedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const markDeploymentActive = `-- name: MarkDeploymentActive :exec
UPDATE deployments
SET status = 'active', commit_hash = $2, image_ref = $3, finished_at = NOW(), updated_at = NOW()
WHERE id = $1
`

type MarkDeploymentActiveParams struct {
	ID         string  `json:"id"`
	CommitHash *string `json:"commit_hash"`
	ImageRef   *string `json:"image_ref"`
}

func (q *Queries) MarkDeploymentActive(ctx context.Context, arg MarkDeploymentActiveParams) error {
	_, err := q.db.Exec(ctx, markDeploymentActive, arg.ID, arg.CommitHash, arg.ImageRef)
	return err
}

const markDeploymentCancelled = `-- name: MarkDeploymentCancelled :exec
UPDATE deployments
SET status = 'cancelled', finished_at = NOW(), updated_at = NOW()
WHERE id = $1
`

func (q *Queries) MarkDeploymentCancelled(ctx context.Context, id string) error {
	_, err := q.db.Exec(ctx, markDeploymentCancelled, id)
	return err
}

const markDeploymentCompleted = `-- name: MarkDeploymentCompleted :exec
UPDATE deployments SET status = 'completed', finished_at = NOW(), updated_at = NOW() WHERE id = $1
`

func (q *Queries) MarkDeploymentCompleted(ctx context.Context, id string) error {
	_, err := q.db.Exec(ctx, markDeploymentCompleted, id)
	return err
}

const markDeploymentCrashed = `-- name: MarkDeploymentCrashed :exec
UPDATE deployments SET status = 'crashed', error_message = $2, finished_at = NOW(), updated_at = NOW() WHERE id = $1
`

type MarkDeploymentCrashedParams struct {
	ID           string  `json:"id"`
	ErrorMessage *string `json:"error_message"`
}

func (q *Queries) MarkDeploymentCrashed(ctx context.Context, arg MarkDeploymentCrashedParams) error {
	_, err := q.db.Exec(ctx, markDeploymentCrashed, arg.ID, arg.ErrorMessage)
	return err
}

const markDeploymentFailed = `-- name: MarkDeploymentFailed :exec
UPDATE deployments
SET status = 'failed', error_message = $2, finished_at = NOW(), updated_at = NOW()
WHERE id = $1
`

type MarkDeploymentFailedParams struct {
	ID           string  `json:"id"`
	ErrorMessage *string `json:"error_message"`
}

func (q *Queries) MarkDeploymentFailed(ctx context.Context, arg MarkDeploymentFailedParams) error {
	_, err := q.db.Exec(ctx, markDeploymentFailed, arg.ID, arg.ErrorMessage)
	return err
}

const markDeploymentRemoved = `-- name: MarkDeploymentRemoved :exec
UPDATE deployments SET status = 'removed', finished_at = NOW(), updated_at = NOW() WHERE id = $1
`

func (q *Queries) MarkDeploymentRemoved(ctx context.Context, id string) error {
	_, err := q.db.Exec(ctx, markDeploymentRemoved, id)
	return err
}

const supersedeActiveDeployment = `-- name: SupersedeActiveDeployment :exec
UPDATE deployments
SET status = 'superseded', finished_at = NOW(), updated_at = NOW()
WHERE service_id = $1 AND status = 'active'
`

func (q *Queries) SupersedeActiveDeployment(ctx context.Context, serviceID string) error {
	_, err := q.db.Exec(ctx, supersedeActiveDeployment, serviceID)
	return err
}

const updateDeploymentBuildProgress = `-- name: UpdateDeploymentBuildProgress :exec
UPDATE deployments
SET build_progress = $2, updated_at = NOW()
WHERE id = $1
`

type UpdateDeploymentBuildProgressParams struct {
	ID            string `json:"id"`
	BuildProgress []byte `json:"build_progress"`
}

func (q *Queries) UpdateDeploymentBuildProgress(ctx context.Context, arg UpdateDeploymentBuildProgressParams) error {
	_, err := q.db.Exec(ctx, updateDeploymentBuildProgress, arg.ID, arg.BuildProgress)
	return err
}

const updateDeploymentBuilding = `-- name: UpdateDeploymentBuilding :exec
UPDATE deployments
SET status = 'building', started_at = NOW(), updated_at = NOW()
WHERE id = $1
`

func (q *Queries) UpdateDeploymentBuilding(ctx context.Context, id string) error {
	_, err := q.db.Exec(ctx, updateDeploymentBuilding, id)
	return err
}

const updateDeploymentCommitHash = `-- name: UpdateDeploymentCommitHash :exec
UPDATE deployments
SET commit_hash = $2, updated_at = NOW()
WHERE id = $1
`

type UpdateDeploymentCommitHashParams struct {
	ID         string  `json:"id"`
	CommitHash *string `json:"commit_hash"`
}

func (q *Queries) UpdateDeploymentCommitHash(ctx context.Context, arg UpdateDeploymentCommitHashParams) error {
	_, err := q.db.Exec(ctx, updateDeploymentCommitHash, arg.ID, arg.CommitHash)
	return err
}

const updateDeploymentDeploying = `-- name: UpdateDeploymentDeploying :exec
UPDATE deployments
SET status = 'deploying', updated_at = NOW()
WHERE id = $1
`

func (q *Queries) UpdateDeploymentDeploying(ctx context.Context, id string) error {
	_, err := q.db.Exec(ctx, updateDeploymentDeploying, id)
	return err
}

const updateDeploymentWorkflowRunID = `-- name: UpdateDeploymentWorkflowRunID :exec
UPDATE deployments
SET workflow_run_id = $2, updated_at = NOW()
WHERE id = $1
`

type UpdateDeploymentWorkflowRunIDParams struct {
	ID            string  `json:"id"`
	WorkflowRunID *string `json:"workflow_run_id"`
}

func (q *Queries) UpdateDeploymentWorkflowRunID(ctx context.Context, arg UpdateDeploymentWorkflowRunIDParams) error {
	_, err := q.db.Exec(ctx, updateDeploymentWorkflowRunID, arg.ID, arg.WorkflowRunID)
	return err
}
